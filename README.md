# Are Watermarked Images Editable? A Model-Agnostic Framework for Watermark-Preserving Text-Guided Image Manipulation

Official implementation of SafeMark, a framework for watermark-preserving text-guided image manipulation across diverse diffusion-based editing pipelines.

## Overview

Diffusion-based image editing enables flexible semantic manipulation but often destroys embedded watermarks, undermining image provenance and attribution.  
SafeMark integrates watermark preservation directly into the editing process, enabling semantic image manipulation while maintaining watermark integrity across heterogeneous editors.

SafeMark is editing-agnostic and can be integrated into multiple diffusion-based editing frameworks.

## Key Features

- Editing-agnostic watermark preservation  
- Plug-and-play with diffusion-based editors  
- No watermark fabrication or transfer  
- Supports multiple datasets and editing pipelines  

## Repository Structure

```text
/
├── Asyrp/
├── DiffusionCLIP/
├── eff-diff-edit/
├── data/
├── requirements.txt
└── README.md
```

## Environment Setup

```bash
conda create -n safemark python=3.8
conda activate safemark
pip install -r requirements.txt
```

Install PyTorch according to your CUDA version:

```bash
pip install torch torchvision torchaudio
```

## Datasets

Supported datasets include:

- CelebA-HQ  
- AFHQ-Dog  
- LSUN-Church  
- LSUN-Bedroom
- Human
- Dog
- Church
- Bedroom

Datasets are provided under the data directory. Images generated by Stable Signature, SleeperMark, and VINE are stored in method-specific subdirectories. Subdirectories suffixed with orig contain unwatermarked images, whereas those suffixed with hid contain images watermarked using HiDDeN.

## Pretrained Watermark Encoder/Decoder

Pretrained watermark models are provided via Google Drive:

DiffusionCLIP: https://drive.google.com/drive/folders/1juWEkCd_RhgUMiewkeqVXlMsazwZ1mbp?usp=sharing

Asyrp: https://drive.google.com/drive/folders/19NNfVvlNCaI5b-xdPh7L816BmSbTxW-P?usp=sharing

Eff-Diff: https://drive.google.com/drive/folders/1M7ZSlw-OWuHSMRGxUCYRiO3hK4brdWML?usp=sharing

After downloading, place files under each edit method folder. For example,

```text
DiffusionCLIP/
├── checkpoint/
├── precomputed/
├── pretrained/
├── out/
├── main.py
├── ...
```

## Running SafeMark

### DiffusionCLIP Backend

```bash
cd DiffusionCLIP
python main.py
```

### Asyrp Backend

```bash
cd Asyrp
python main.py
```

### Efficient Diffusion Editing Backend

```bash
cd eff-diff-edit
python main.py
```

## Evaluation

```bash
In eval365.py: set --decoder=hid (or sig, sleep, vine)  --attr=[attribute you want to edit], --data_path=[watermarked image path]
python eval365.py
```

Metrics include:

- Watermark bit accuracy  
- CLIP similarity  
- FID
- IS

## Reproducing Paper Results

###Table 1:

For DiffusionCLIP on VINE LSUN-Ch. (or LSUN-Bd.)

```bash
In main.py: set --config=church.yml (or bedroom.yml) --attack=True --decoder=vine --wm_data_path='./data/VINE/church_vine' (or './data/VINE/bedroom_vine') --edit_attr=[attribute you want to edit]
python main.py
```

For DiffusionCLIP on SleeperMark Ch. (or Bd.)

```bash
In main.py: set --config=church.yml (or bedroom.yml) --attack=True --decoder=sleep --wm_data_path='./data/SleepMark/church_sleep' (or './data/SleepMark/bedroom_sleep') --edit_attr=[attribute you want to edit]
python main.py
```

For the rest edit method, repeat the same command in each folder.

###Table 2 & 3:

For DiffusionCLIP on VINE LSUN-Church (or LSUN-Bedroom)

```bash
In main.py: set --config=church.yml (or bedroom.yml) --attack=True --decoder=vine --wm_data_path='./data/VINE/church_vine' (or './data/VINE/bedroom_vine') --edit_attr=[attribute you want to edit]
python main.py
```

For DiffusionCLIP on HiDDeN CelebA (or AFHQ-Dog)

```bash
In main.py: set --config=celeba.yml (or afhq.yml) --attack=True --decoder=hid --wm_data_path='./data/celeba_hid' (or './data/afhq_hid') --edit_attr=[attribute you want to edit]
python main.py
```

For the rest edit method, repeat the same command in each folder.

###Figure 2 & 3:

For DiffusionCLIP on SleeperMark Church (or Bedroom)

```bash
In main.py: set --config=church.yml (or bedroom.yml) --attack=True --decoder=sleep --wm_data_path='./data/SleepMark/church_sleep' (or './data/SleepMark/bedroom_sleep') --edit_attr=[attribute you want to edit]
python main.py
```

For DiffusionCLIP on StableSignature Human (or Dog)

```bash
In main.py: set --config=celeba.yml (or afhq.yml) --attack=True --decoder=sig --wm_data_path='./data/StableSignature/celeba_sig' (or './data/StableSignature/afhq_hid') --edit_attr=[attribute you want to edit]
python main.py
```

For the rest edit method, repeat the same command in each folder.

###Figure 4:

```bash
cd DiffusionCLIP
In main.py: set --config=celeba.yml --attack=True --decoder=hid --wm_data_path='./data/celeba_hid' --edit_attr=[attribute you want to edit] --p_crop=1.0 (or other distortions)
python main.py
```
